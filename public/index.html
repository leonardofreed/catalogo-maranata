<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Produtos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* Estilos removidos do menu sidebar */
        
        .toggle-btn {
            overflow: hidden;
        }
        
        .toggle-btn::before {
            content: '☰';
            position: absolute;
            transition: all 0.3s ease;
        }
        
        .toggle-btn.collapsed::before {
            transform: rotate(90deg);
        }

        .container {
            width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom) + 64px);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            margin: -20px -20px 0 -20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }



        .filters {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #eee;
            margin: 0 -20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .filter-group input,
        .filter-group select {
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 0;
        }

        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f0f0f0;
        }

        .product-info {
            padding: 20px;
        }

        .product-category {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }

        .product-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .product-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }

        .product-stock {
            font-size: 14px;
            color: #28a745;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .add-to-cart-btn {
            width: 100%;
            margin-top: 10px;
            font-size: 14px;
            padding: 10px 15px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2rem;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            text-align: center;
        }

        .no-products {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .no-products h3 {
            margin-bottom: 10px;
        }


        /* Responsividade para telas grandes */
        @media (min-width: 1200px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 30px;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }

            /* Esconder filtro de categoria no mobile - só aparece no menu fixo */
            .filter-group:has(#categoria) {
                display: none;
            }
        }
        /* Menu inferior fixo */
        .bottom-nav {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: 64px;
            padding-bottom: env(safe-area-inset-bottom);
            background: #ffffff;
            border-top: 1px solid #eee;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            align-items: center;
            justify-items: center;
            z-index: 1000;
            box-shadow: 0 -8px 24px rgba(0,0,0,0.08);
        }

        .bottom-nav .nav-item {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: #555;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s ease, background 0.2s ease;
            background: transparent;
            border: none;
            outline: none;
        }

        .bottom-nav .icon {
            font-size: 20px;
        }

        .bottom-nav .nav-item.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.08);
        }

        .cart-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
        }

        .nav-item {
            position: relative;
        }

        @media (max-width: 768px) {
            .bottom-nav .nav-item .label {
                display: none;
            }
            
            /* CARRINHO MOBILE - LAYOUT COMPLETO */
            .carrinho-modal {
                padding: 0;
                align-items: stretch;
            }
            
            .carrinho-content {
                max-width: 100vw;
                max-height: 100vh;
                width: 100vw;
                height: 100vh;
                margin: 0;
                border-radius: 0;
                display: flex;
                flex-direction: column;
            }
            
            .carrinho-header {
                flex-shrink: 0;
                padding: 20px;
            }
            
            .carrinho-body {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0;
            }
            
            .carrinho-footer {
                flex-shrink: 0;
                padding: 20px;
                background: #f8f9fa;
                border-top: 2px solid #e9ecef;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            }
            
            .frete-section {
                flex-shrink: 0;
                padding: 20px;
                margin: 0;
                background: #f8f9fa;
                border-top: 1px solid #e9ecef;
            }
            
            .carrinho-item {
                padding: 15px 20px;
                display: flex;
                align-items: center;
                gap: 15px;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .carrinho-item-info {
                flex: 1;
                margin-left: 0;
            }
            
            .carrinho-item-nome {
                font-size: 0.9rem;
                line-height: 1.3;
                word-wrap: break-word;
                margin-bottom: 5px;
            }
            
            .carrinho-item-preco {
                font-size: 1rem;
                color: #667eea;
                font-weight: 700;
            }
            
            .carrinho-item-controls {
                display: flex;
                align-items: center;
                gap: 10px;
                flex-shrink: 0;
            }
            
            .quantity-btn, .remove-btn {
                width: 40px;
                height: 40px;
                font-size: 18px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                border: none;
                cursor: pointer;
                transition: all 0.2s;
            }
            
            .quantity-btn {
                background: #f0f0f0;
                color: #333;
            }
            
            .quantity-btn:hover {
                background: #667eea;
                color: white;
            }
            
            .remove-btn {
                background: #ff4757;
                color: white;
            }
            
            .remove-btn:hover {
                background: #ff3742;
            }
            
            .quantity-display {
                font-size: 16px;
                min-width: 40px;
                text-align: center;
                font-weight: 600;
            }
            
            .carrinho-total {
                font-size: 1.2rem;
                margin-bottom: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .carrinho-total-valor {
                font-size: 1.4rem;
                color: #667eea;
                font-weight: 700;
            }
            
            .carrinho-actions {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-carrinho {
                padding: 15px;
                font-size: 16px;
                border-radius: 10px;
                border: none;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s;
            }
            
            .btn-continuar {
                background: #6c757d;
                color: white;
            }
            
            .btn-continuar:hover {
                background: #5a6268;
            }
            
            .btn-finalizar {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }
            
            .btn-finalizar:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }
            
            .frete-input-group {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            
            .frete-input {
                font-size: 16px;
                padding: 12px;
                border: 2px solid #bdc3c7;
                border-radius: 8px;
            }
            
            .btn-calcular-frete {
                padding: 12px 20px;
                background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
            }
        }
        
        /* Telas muito pequenas - ajustes finais */
        @media (max-width: 480px) {
            .carrinho-header {
                padding: 15px;
            }
            
            .carrinho-header h3 {
                font-size: 1.3rem;
            }
            
            .carrinho-item {
                padding: 12px 15px;
            }
            
            .carrinho-item-nome {
                font-size: 0.85rem;
            }
            
            .carrinho-footer {
                padding: 15px;
            }
            
            .btn-carrinho {
                padding: 12px;
                font-size: 14px;
            }
        }

        /* Modal de categorias para mobile */
        .categoria-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .categoria-modal.show {
            display: flex;
        }

        .categoria-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .categoria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .categoria-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .categoria-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .categoria-item {
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 600;
        }

        .categoria-item:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .categoria-item.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        /* Modal de carrinho moderno */
        .carrinho-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .carrinho-modal.show {
            display: flex;
        }

        .carrinho-content {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: slideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .carrinho-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .carrinho-header > div {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .carrinho-count {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .carrinho-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .carrinho-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .carrinho-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .carrinho-body {
            padding: 0;
            flex: 1;
            overflow-y: auto;
            position: relative;
            min-height: 0;
        }
        
        /* Indicador de scroll para carrinho */
        .carrinho-body::after {
            content: '↓ Role para ver mais itens';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(transparent, rgba(102, 126, 234, 0.1));
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
        }
        
        .carrinho-body.scrollable::after {
            opacity: 1;
        }

        .carrinho-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
            min-height: 80px;
        }

        .carrinho-item:hover {
            background: #f8f9fa;
        }

        .carrinho-item:last-child {
            border-bottom: none;
        }

        .carrinho-item-info {
            flex: 1;
            margin-left: 15px;
        }

        .carrinho-item-nome {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }

        .carrinho-item-preco {
            color: #667eea;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .carrinho-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            background: #f0f0f0;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
        }

        .quantity-btn:hover {
            background: #667eea;
            color: white;
        }

        .quantity-display {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }

        .remove-btn:hover {
            background: #ff3742;
            transform: scale(1.1);
        }

        .carrinho-footer {
            background: #f8f9fa;
            padding: 25px;
            border-top: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .carrinho-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
        }

        .carrinho-total-valor {
            color: #667eea;
            font-size: 1.5rem;
        }

        .carrinho-actions {
            display: flex;
            gap: 15px;
        }

        .btn-carrinho {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .btn-continuar {
            background: #6c757d;
            color: white;
        }

        .btn-continuar:hover {
            background: #5a6268;
        }

        .btn-finalizar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-finalizar:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .carrinho-vazio {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .carrinho-vazio-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .carrinho-vazio h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .carrinho-vazio p {
            margin: 0;
        }

        /* Calculadora de frete */
        .frete-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .frete-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .frete-header h4 {
            margin: 0;
            color: #2c3e50;
        }

        .frete-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .frete-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
        }

        .frete-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn-calcular-frete {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-calcular-frete:hover {
            transform: translateY(-2px);
        }

        .frete-resultado {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
            display: none;
        }

        .frete-resultado.show {
            display: block;
        }

        .frete-resultado.error {
            border-left-color: #e74c3c;
        }

        .frete-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .frete-valor {
            font-size: 1.2rem;
            font-weight: 700;
            color: #27ae60;
        }

        .frete-prazo {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .frete-mensagem {
            color: #2c3e50;
            font-size: 0.9rem;
        }

        .loading-frete {
            display: none;
            text-align: center;
            color: #7f8c8d;
        }

        .loading-frete.show {
            display: block;
        }

    </style>
</head>
<body>
    
    <div class="container" id="main-container">
        <div class="header">
            <h1>🛍️ Catálogo de Produtos</h1>
            <p>quase24horas.top - Explore nossa coleção completa de produtos</p>
        </div>



        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="busca">🔍 Buscar Produtos</label>
                    <input type="text" id="busca" placeholder="Digite o nome ou descrição do produto...">
                </div>
                <div class="filter-group">
                    <label for="categoria">📂 Categoria</label>
                    <select id="categoria">
                        <option value="">Todas as categorias</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="ordenar">🔄 Ordenar por</label>
                    <select id="ordenar">
                        <option value="">Mais recentes</option>
                        <option value="nome">Nome (A-Z)</option>
                        <option value="preco_asc">Preço (menor)</option>
                        <option value="preco_desc">Preço (maior)</option>
                        <option value="categoria">Categoria</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn" onclick="carregarProdutos()">Filtrar</button>
                </div>
            </div>
            
        </div>


        <div id="loading" class="loading" style="display: none;">
            Carregando produtos...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div class="products-grid" id="products-grid">
            <!-- Produtos serão carregados aqui -->
        </div>
    </div>

    

    <!-- Modal de categorias para mobile -->
    <div class="categoria-modal" id="categoria-modal">
        <div class="categoria-content">
            <div class="categoria-header">
                <h3>📂 Escolher Categoria</h3>
                <button class="close-btn" id="close-categoria-modal">&times;</button>
            </div>
            <div class="categoria-list" id="categoria-list">
                <!-- Categorias serão carregadas aqui -->
            </div>
        </div>
    </div>

    <!-- Modal de carrinho moderno -->
    <div class="carrinho-modal" id="carrinho-modal">
        <div class="carrinho-content">
            <div class="carrinho-header">
                <div>
                    <h3>🛒 Meu Carrinho</h3>
                    <span class="carrinho-count" id="carrinho-count" style="font-size: 0.9rem; opacity: 0.9;">0 itens</span>
                </div>
                <button class="carrinho-close" id="close-carrinho-modal">&times;</button>
            </div>
            <div class="carrinho-body" id="carrinho-body">
                <!-- Itens do carrinho serão carregados aqui -->
            </div>
            
            <!-- Seção de Frete -->
            <div class="frete-section" id="frete-section" style="display: none;">
                <div class="frete-header">
                    <h4>🚚 Calcular Frete</h4>
                </div>
                <div class="frete-input-group">
                    <input type="text" id="cep-input" class="frete-input" placeholder="Digite seu CEP (ex: 01234-567)" maxlength="9">
                    <button onclick="calcularFrete()" class="btn-calcular-frete">Calcular</button>
                </div>
                <div class="loading-frete" id="loading-frete">
                    Calculando frete...
                </div>
                <div class="frete-resultado" id="frete-resultado">
                    <!-- Resultado do frete será inserido aqui -->
                </div>
            </div>
            
            <div class="carrinho-footer" id="carrinho-footer" style="display: none;">
                <div class="carrinho-total">
                    <span>Total:</span>
                    <span class="carrinho-total-valor" id="carrinho-total">R$ 0,00</span>
                </div>
                <div class="carrinho-actions">
                    <button class="btn-carrinho btn-continuar" onclick="fecharCarrinho()">
                        Continuar Comprando
                    </button>
                    <button class="btn-carrinho btn-finalizar" onclick="finalizarCompra()">
                        Finalizar Compra
                    </button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav" id="bottom-nav">
        <button class="nav-item" id="nav-home" aria-label="Início">
            <span class="icon">🏠</span>
            <span class="label">Início</span>
        </button>
        <button class="nav-item" id="nav-categoria" aria-label="Categoria">
            <span class="icon">📂</span>
            <span class="label">Categoria</span>
        </button>
        <button class="nav-item" id="nav-carrinho" aria-label="Carrinho">
            <span class="icon">🛒</span>
            <span class="label">Carrinho</span>
            <span class="cart-badge" id="cart-badge" style="display: none;">0</span>
        </button>
    </nav>

    <script>
        // Menu inferior fixo (interações)
        (function() {
            const home = document.getElementById('nav-home');
            const categoria = document.getElementById('nav-categoria');
            const carrinho = document.getElementById('nav-carrinho');
            const items = [home, categoria, carrinho].filter(Boolean);

            function setActive(el) {
                items.forEach(i => i.classList.toggle('active', i === el));
            }

            home && home.addEventListener('click', () => {
                setActive(home);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            categoria && categoria.addEventListener('click', () => {
                setActive(categoria);
                // Verificar se é mobile (largura < 768px)
                if (window.innerWidth <= 768) {
                    // Abrir modal de categorias no mobile
                    document.getElementById('categoria-modal').classList.add('show');
                } else {
                    // Comportamento desktop - focar no select
                    const select = document.getElementById('categoria');
                    if (select) {
                        select.focus();
                        select.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });

            carrinho && carrinho.addEventListener('click', () => {
                setActive(carrinho);
                abrirCarrinho();
            });
        })();

        // Gerenciar modal de categorias
        (function() {
            const modal = document.getElementById('categoria-modal');
            const closeBtn = document.getElementById('close-categoria-modal');
            const categoriaList = document.getElementById('categoria-list');
            let categorias = [];

            // Fechar modal
            function closeModal() {
                modal.classList.remove('show');
            }

            // Abrir modal
            function openModal() {
                modal.classList.add('show');
            }

            // Event listeners do modal
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Carregar categorias no modal
            function loadCategoriasModal() {
                categoriaList.innerHTML = '';
                
                // Usar categorias compartilhadas globalmente
                const categoriasData = window.categoriasData || [];
                
                // Adicionar opção "Todas as categorias"
                const todasItem = document.createElement('div');
                todasItem.className = 'categoria-item';
                todasItem.textContent = 'Todas as categorias';
                todasItem.addEventListener('click', () => {
                    selectCategoria('');
                    closeModal();
                });
                categoriaList.appendChild(todasItem);

                // Adicionar categorias
                categoriasData.forEach(categoria => {
                    const item = document.createElement('div');
                    item.className = 'categoria-item';
                    item.textContent = categoria;
                    item.addEventListener('click', () => {
                        selectCategoria(categoria);
                        closeModal();
                    });
                    categoriaList.appendChild(item);
                });

                // Atualizar estado ativo
                updateActiveCategoria();
            }

            // Selecionar categoria
            function selectCategoria(categoria) {
                const select = document.getElementById('categoria');
                if (select) {
                    select.value = categoria;
                    carregarProdutos();
                }
            }

            // Atualizar estado ativo das categorias
            function updateActiveCategoria() {
                const select = document.getElementById('categoria');
                const selectedValue = select ? select.value : '';
                
                categoriaList.querySelectorAll('.categoria-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.textContent === selectedValue || 
                        (selectedValue === '' && item.textContent === 'Todas as categorias')) {
                        item.classList.add('active');
                    }
                });
            }

            // Expor funções globalmente
            window.openCategoriaModal = openModal;
            window.loadCategoriasModal = loadCategoriasModal;
            window.updateActiveCategoria = updateActiveCategoria;
        })();

        // Carregar categorias
        async function carregarCategorias() {
            try {
                const response = await fetch('/api/categorias');
                const categorias = await response.json();
                
                const select = document.getElementById('categoria');
                select.innerHTML = '<option value="">Todas as categorias</option>';
                
                categorias.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = categoria;
                    select.appendChild(option);
                });

                // Carregar categorias no modal também
                if (window.loadCategoriasModal) {
                    // Armazenar categorias para o modal
                    const modalScope = document.querySelector('script').textContent;
                    // Usar uma abordagem diferente para compartilhar dados
                    window.categoriasData = categorias;
                    window.loadCategoriasModal();
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        // Carregar produtos
        async function carregarProdutos() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const productsGrid = document.getElementById('products-grid');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            productsGrid.innerHTML = '';

            try {
                const params = new URLSearchParams();
                const busca = document.getElementById('busca').value;
                const categoria = document.getElementById('categoria').value;
                const ordenar = document.getElementById('ordenar').value;

                if (busca) params.append('busca', busca);
                if (categoria) params.append('categoria', categoria);
                if (ordenar) params.append('ordenar', ordenar);

                const response = await fetch(`/api/produtos?${params}`);
                const produtos = await response.json();

                loading.style.display = 'none';

                if (produtos.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="no-products">
                            <h3>Nenhum produto encontrado</h3>
                            <p>Tente ajustar os filtros de busca</p>
                        </div>
                    `;
                    return;
                }

                produtos.forEach(produto => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.innerHTML = `
                        <img src="${produto.imagem_url || 'https://via.placeholder.com/300x200?text=Sem+Imagem'}" 
                             alt="${produto.nome}" 
                             class="product-image"
                             onerror="this.src='https://via.placeholder.com/300x200?text=Sem+Imagem'">
                        <div class="product-info">
                            <div class="product-category">${produto.categoria}</div>
                            <h3 class="product-name">${produto.nome}</h3>
                            <p class="product-description">${produto.descricao || 'Sem descrição'}</p>
                            <div class="product-price">R$ ${parseFloat(produto.preco).toFixed(2)}</div>
                            <div class="product-stock">📦 ${produto.estoque} em estoque</div>
                            <button class="btn add-to-cart-btn" onclick="adicionarAoCarrinho(${produto.id}, '${produto.nome}', ${produto.preco})">
                                🛒 Adicionar ao Carrinho
                            </button>
                        </div>
                    `;
                    productsGrid.appendChild(productCard);
                });

            } catch (error) {
                loading.style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = 'Erro ao carregar produtos: ' + error.message;
            }
        }


        // Event listeners
        document.getElementById('busca').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                carregarProdutos();
            }
        });
        
        // Listener para redimensionamento - garantir layout mobile
        window.addEventListener('resize', function() {
            const carrinhoModal = document.getElementById('carrinho-modal');
            if (carrinhoModal.classList.contains('show') && window.innerWidth <= 768) {
                const carrinhoContent = document.querySelector('.carrinho-content');
                const carrinhoBody = document.getElementById('carrinho-body');
                const carrinhoFooter = document.getElementById('carrinho-footer');
                
                carrinhoContent.style.height = '100vh';
                carrinhoContent.style.maxHeight = '100vh';
                carrinhoBody.style.flex = '1';
                carrinhoBody.style.overflowY = 'auto';
                carrinhoFooter.style.flexShrink = '0';
            }
        });

        document.getElementById('categoria').addEventListener('change', () => {
            carregarProdutos();
            // Atualizar estado ativo no modal se existir
            if (window.updateActiveCategoria) {
                window.updateActiveCategoria();
            }
        });
        document.getElementById('ordenar').addEventListener('change', carregarProdutos);

        // Sistema de carrinho moderno
        let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
        let freteCalculado = null;

        function adicionarAoCarrinho(id, nome, preco) {
            const itemExistente = carrinho.find(item => item.id === id);
            
            if (itemExistente) {
                itemExistente.quantidade += 1;
            } else {
                carrinho.push({
                    id: id,
                    nome: nome,
                    preco: preco,
                    quantidade: 1
                });
            }
            
            localStorage.setItem('carrinho', JSON.stringify(carrinho));
            atualizarBadgeCarrinho();
            
            // Feedback visual moderno
            const btn = event.target;
            const textoOriginal = btn.textContent;
            btn.textContent = '✅ Adicionado!';
            btn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            btn.style.transform = 'scale(1.05)';
            
            setTimeout(() => {
                btn.textContent = textoOriginal;
                btn.style.background = '';
                btn.style.transform = '';
            }, 1500);
        }

        function atualizarBadgeCarrinho() {
            const badge = document.getElementById('cart-badge');
            const totalItens = carrinho.reduce((total, item) => total + item.quantidade, 0);
            
            if (totalItens > 0) {
                badge.textContent = totalItens;
                badge.style.display = 'flex';
                // Animação do badge
                badge.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    badge.style.transform = 'scale(1)';
                }, 200);
            } else {
                badge.style.display = 'none';
            }
        }

        function abrirCarrinho() {
            const modal = document.getElementById('carrinho-modal');
            modal.classList.add('show');
            renderizarCarrinho();
            
            // Forçar layout correto no mobile
            setTimeout(() => {
                const carrinhoContent = document.querySelector('.carrinho-content');
                const carrinhoBody = document.getElementById('carrinho-body');
                const carrinhoFooter = document.getElementById('carrinho-footer');
                
                // Garantir que o footer sempre fique visível
                if (window.innerWidth <= 768) {
                    carrinhoContent.style.height = '100vh';
                    carrinhoContent.style.maxHeight = '100vh';
                    carrinhoBody.style.flex = '1';
                    carrinhoBody.style.overflowY = 'auto';
                    carrinhoFooter.style.flexShrink = '0';
                }
            }, 100);
            
            // Adicionar listener para scroll do carrinho
            const carrinhoBody = document.getElementById('carrinho-body');
            carrinhoBody.addEventListener('scroll', function() {
                const isAtBottom = this.scrollTop + this.clientHeight >= this.scrollHeight - 5;
                if (isAtBottom) {
                    this.classList.remove('scrollable');
                } else {
                    this.classList.add('scrollable');
                }
            });
        }

        function fecharCarrinho() {
            const modal = document.getElementById('carrinho-modal');
            modal.classList.remove('show');
        }

        function renderizarCarrinho() {
            const carrinhoBody = document.getElementById('carrinho-body');
            const carrinhoFooter = document.getElementById('carrinho-footer');
            const freteSection = document.getElementById('frete-section');
            
            if (carrinho.length === 0) {
                carrinhoBody.innerHTML = `
                    <div class="carrinho-vazio">
                        <div class="carrinho-vazio-icon">🛒</div>
                        <h4>Seu carrinho está vazio</h4>
                        <p>Adicione alguns produtos para começar suas compras!</p>
                    </div>
                `;
                carrinhoFooter.style.display = 'none';
                freteSection.style.display = 'none';
                return;
            }
            
            carrinhoFooter.style.display = 'block';
            freteSection.style.display = 'block';
            
            let html = '';
            let total = 0;
            
            carrinho.forEach((item, index) => {
                const subtotal = item.preco * item.quantidade;
                total += subtotal;
                
                html += `
                    <div class="carrinho-item">
                        <div class="carrinho-item-info">
                            <div class="carrinho-item-nome">${item.nome}</div>
                            <div class="carrinho-item-preco">R$ ${item.preco.toFixed(2)}</div>
                        </div>
                        <div class="carrinho-item-controls">
                            <button class="quantity-btn" onclick="alterarQuantidade(${index}, -1)">-</button>
                            <span class="quantity-display">${item.quantidade}</span>
                            <button class="quantity-btn" onclick="alterarQuantidade(${index}, 1)">+</button>
                            <button class="remove-btn" onclick="removerItem(${index})" title="Remover item">×</button>
                        </div>
                    </div>
                `;
            });
            
            carrinhoBody.innerHTML = html;
            atualizarTotalCarrinho(total);
            
            // Atualizar contador de itens
            const totalItens = carrinho.reduce((total, item) => total + item.quantidade, 0);
            const carrinhoCount = document.getElementById('carrinho-count');
            carrinhoCount.textContent = `${totalItens} ${totalItens === 1 ? 'item' : 'itens'}`;
            
            // Verificar se há scroll e adicionar indicador visual
            setTimeout(() => {
                const carrinhoBodyElement = document.getElementById('carrinho-body');
                if (carrinhoBodyElement.scrollHeight > carrinhoBodyElement.clientHeight) {
                    carrinhoBodyElement.classList.add('scrollable');
                } else {
                    carrinhoBodyElement.classList.remove('scrollable');
                }
            }, 100);
        }

        function atualizarTotalCarrinho(subtotal) {
            const totalElement = document.getElementById('carrinho-total');
            let total = subtotal;
            
            if (freteCalculado && freteCalculado.disponivel) {
                total += freteCalculado.valor_frete;
            }
            
            totalElement.textContent = `R$ ${total.toFixed(2)}`;
        }

        // Funções de frete
        function calcularFrete() {
            const cepInput = document.getElementById('cep-input');
            const cep = cepInput.value.replace(/[^0-9]/g, '');
            
            if (cep.length !== 8) {
                mostrarResultadoFrete({
                    disponivel: false,
                    mensagem: 'CEP deve ter 8 dígitos'
                }, true);
                return;
            }
            
            const loading = document.getElementById('loading-frete');
            const resultado = document.getElementById('frete-resultado');
            
            loading.classList.add('show');
            resultado.classList.remove('show');
            
            fetch(`/api/frete/${cep}`)
                .then(response => response.json())
                .then(data => {
                    loading.classList.remove('show');
                    freteCalculado = data;
                    mostrarResultadoFrete(data, !data.disponivel);
                    
                    // Atualizar total do carrinho
                    const subtotal = carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);
                    atualizarTotalCarrinho(subtotal);
                })
                .catch(error => {
                    loading.classList.remove('show');
                    mostrarResultadoFrete({
                        disponivel: false,
                        mensagem: 'Erro ao calcular frete: ' + error.message
                    }, true);
                });
        }

        function mostrarResultadoFrete(data, isError = false) {
            const resultado = document.getElementById('frete-resultado');
            
            if (data.disponivel) {
                resultado.innerHTML = `
                    <div class="frete-info">
                        <div>
                            <div class="frete-valor">R$ ${data.valor_frete.toFixed(2)}</div>
                        </div>
                        <div class="frete-mensagem">${data.mensagem}</div>
                    </div>
                `;
                resultado.classList.remove('error');
            } else {
                resultado.innerHTML = `
                    <div class="frete-mensagem" style="color: #e74c3c;">
                        ${data.mensagem}
                    </div>
                `;
                resultado.classList.add('error');
            }
            
            resultado.classList.add('show');
        }

        // Formatação automática do CEP
        document.getElementById('cep-input').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            e.target.value = value;
        });

        // Calcular frete ao pressionar Enter
        document.getElementById('cep-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calcularFrete();
            }
        });

        function alterarQuantidade(index, delta) {
            carrinho[index].quantidade += delta;
            
            if (carrinho[index].quantidade <= 0) {
                carrinho.splice(index, 1);
            }
            
            localStorage.setItem('carrinho', JSON.stringify(carrinho));
            atualizarBadgeCarrinho();
            renderizarCarrinho();
        }

        function removerItem(index) {
            carrinho.splice(index, 1);
            localStorage.setItem('carrinho', JSON.stringify(carrinho));
            atualizarBadgeCarrinho();
            renderizarCarrinho();
        }

        async function finalizarCompra() {
            if (carrinho.length === 0) {
                alert('Seu carrinho está vazio!');
                return;
            }
            
            const subtotal = carrinho.reduce((total, item) => total + (item.preco * item.quantidade), 0);
            const frete = freteCalculado && freteCalculado.disponivel ? freteCalculado.valor_frete : 0;
            const total = subtotal + frete;
            
            // Buscar configurações do WhatsApp
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                if (!settings.whatsapp_number) {
                    alert('⚠️ Sistema não configurado!\n\nO administrador precisa configurar o número do WhatsApp para receber pedidos.');
                    return;
                }
                
                // Preparar dados do pedido
                const cep = document.getElementById('cep-input').value || 'Não informado';
                const itens = carrinho.map(item => 
                    `• ${item.nome} - Qtd: ${item.quantidade} - R$ ${(item.preco * item.quantidade).toFixed(2)}`
                ).join('\n');
                
                // Usar mensagem personalizada ou padrão
                let mensagem = settings.whatsapp_message || `Olá! Recebi um novo pedido através do site:

🛒 *Resumo do Pedido:*
📦 Subtotal: R$ ${subtotal.toFixed(2)}
🚚 Frete: R$ ${frete.toFixed(2)}
💰 Total: R$ ${total.toFixed(2)}

📦 *Itens:*
${itens}

📍 *CEP: ${cep}*

Por favor, confirme o pedido e informe a forma de pagamento.

Obrigado!`;
                
                // Substituir variáveis na mensagem
                mensagem = mensagem
                    .replace('{resumo_pedido}', `📦 Subtotal: R$ ${subtotal.toFixed(2)}\n🚚 Frete: R$ ${frete.toFixed(2)}\n💰 Total: R$ ${total.toFixed(2)}`)
                    .replace('{total}', total.toFixed(2))
                    .replace('{itens}', itens)
                    .replace('{frete}', frete.toFixed(2))
                    .replace('{cep}', cep);
                
                // Abrir WhatsApp
                const whatsappUrl = `https://wa.me/${settings.whatsapp_number}?text=${encodeURIComponent(mensagem)}`;
                window.open(whatsappUrl, '_blank');
                
                // Limpar carrinho após envio
                carrinho = [];
                freteCalculado = null;
                localStorage.removeItem('carrinho');
                atualizarBadgeCarrinho();
                fecharCarrinho();
                
                alert('🎉 Pedido enviado para o WhatsApp!\n\nAguarde a confirmação do vendedor.');
                
            } catch (error) {
                console.error('Erro ao finalizar compra:', error);
                alert('❌ Erro ao processar pedido. Tente novamente.');
            }
        }

        // Event listeners do modal de carrinho
        document.getElementById('close-carrinho-modal').addEventListener('click', fecharCarrinho);
        document.getElementById('carrinho-modal').addEventListener('click', (e) => {
            if (e.target.id === 'carrinho-modal') {
                fecharCarrinho();
            }
        });

        // Inicializar página
        document.addEventListener('DOMContentLoaded', function() {
            carregarCategorias();
            carregarProdutos();
            atualizarBadgeCarrinho();
        });
    </script>
</body>
</html>
